upstream httpbin-backends {
    server nginx-youtube-httpbin-1;
    server nginx-youtube-httpbin-2;
    server netcat:8888 down;

    zone httpbin-zone 64k;
}

server {
    listen 80;
    server_name ~^(?<account>.+)\.httpbin\.local$;

    include /etc/nginx/includes/proxy_timeouts.conf;

    location / {
        proxy_cache_bypass $http_x_cache_invalidate;
        proxy_no_cache $http_x_skip_cache;

        proxy_cache httpbin-cache;
        proxy_cache_valid 200 1m;
        proxy_cache_valid 301 302 10m;
        proxy_cache_valid 404 5m;
        proxy_cache_use_stale error timeout invalid_header updating;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        proxy_cache_min_uses 1;
        proxy_cache_revalidate on;
        #proxy_cache_lock_timeout ...
        #proxy_cache_lock_age ...

        proxy_ignore_headers x-accel-expires cache-control expires vary;

        proxy_cache_key $scheme$proxy_host$request_uri;
        add_header x-cache-key $scheme$proxy_host$request_uri;
        add_header x-cache-status $upstream_cache_status;

        expires 10m;

        #proxy_cache_valid 5m; = proxy_cache_valid 200 301 302 5m;
        #proxy_cache_valid any 5m; = proxy_cache_valid 200 301 302, 404, ... 5m;

        error_page 404 /50x.html;
        proxy_intercept_errors on;
        proxy_next_upstream error timeout http_500 http_404;

        proxy_set_header Host $host;
        proxy_set_header X-Host $http_host;
        proxy_set_header X-Account $account;
        proxy_pass http://httpbin-backends;
    }
}
