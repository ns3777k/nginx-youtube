upstream httpbin-backends {
    server nginx-youtube-httpbin-1 max_fails=9999;
    server nginx-youtube-httpbin-2 max_fails=9999;
    server netcat:8888 down;

    zone httpbin-zone 64k;
}

upstream httpbin-backends-test {
    server netcat:8888;
}

map $host $account_upstream {
    default "httpbin-backends";

    admin.httpbin.local "httpbin-backends-test";
    internal.httpbin.local "httpbin-backends-test";
    test.httpbin.local "httpbin-backends-test";
    qa.httpbin.local "httpbin-backends-test";
}

server {
    listen 80;
    server_name ~^(?<account>.+)\.httpbin\.local$;

    include /etc/nginx/includes/proxy_timeouts.conf;

    location = /50x.html {
        internal;
        root /usr/share/nginx/html;
    }

    location /docs {
        error_page 404 /50x.html;
        alias /usr/share/nginx/html;
    }

    location /status {
        proxy_pass http://httpbin-backends/testing;
    }

    location / {
        error_page 404 /50x.html;
        proxy_intercept_errors on;
        proxy_read_timeout 10s;
        proxy_next_upstream error timeout http_500 http_404;

        proxy_hide_header test;
        #proxy_ignore_headers ...;
        proxy_pass_header server;
        proxy_set_header Host $host;
        proxy_set_header X-Host $http_host;
        proxy_set_header X-Account $account;
        proxy_pass http://$account_upstream;
    }
}
